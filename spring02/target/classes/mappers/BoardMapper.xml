<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
 PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
 "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 <mapper namespace="board">
	 <!-- 게시글 전체 목록 조회 (검색) -->
	 <select id="listAll" resultType="com.hatsnake.spring02.domain.BoardDTO">
	 	<include refid="pagingHeader"></include>
	 	select rownum, bno, title, content, writer, regdate, viewcnt,
	 	(select count(*) from reply where bno=b.bno) as recnt, show
	 	from board b
	 	<!-- WHERE절을 include 태그로 삽입 -->
	 	<include refid="search"></include>
	 	order by bno desc, regdate desc
	 	<include refid="pagingFooter"></include>
	 </select>
	 
	 <!-- 게시글 레코드 갯수 -->
	 <select id="countArticle" resultType="int">
	 	select count(*) from board
	 	<include refid="search"></include>
	 </select>
	 
	 <!-- search(where절) mybatis include -->
	 <sql id="search">
	 	<choose>
	 		<!-- 검색옵션이 전체 검색일 경우 -->
	 		<when test="searchOption == 'all'">
	 			where writer like '%'||#{keyword}||'%'
	 			or content like '%'||#{keyword}||'%'
	 			or title like '%'||#{keyword}||'%'
	 		</when>
	 		<!-- 전체 검색이 아닐 경우 -->
	 		<otherwise>
	 			where ${searchOption} like '%'||#{keyword}||'%'
	 		</otherwise>
	 	</choose>
	 </sql>
	 
	 <!-- 페이징 sql -->
	 <sql id="pagingHeader">
	 	select * from (
	 		select rownum as rn, a.* from(
	 </sql>
	 <sql id="pagingFooter">
	 		) a
	 	) where rn between #{start} and #{end}
	 </sql>
	 
	 <!-- 게시글 작성 -->
	 <insert id="insert">
	 	insert into board (bno, title, content, writer, show) 
	 	values ((select nvl(max(bno)+1, 1) from board),
	 		#{title}, #{content}, #{writer}, 'y'
	 	)
	 </insert>
	
	 <!-- 게시글 상세보기 조회 -->
	 <select id="view" resultType="com.hatsnake.spring02.domain.BoardDTO">
	 	 select bno, title, content, b.regdate, writer, viewcnt, name, show 
	 	 from board b, users u
	 	 where b.writer = u.userid
	 	 and bno = #{bno}
	 </select>
	 
	 <!-- 게시글 조회수 증가 처리 -->
	 <update id="increaseViewcnt">
	 	update board set viewcnt = viewcnt + 1
	 	where bno = #{bno}
	 </update>
	 
	 <!-- 게시글 수정 처리 -->
	 <update id="updateArticle">
	 	update board set 
	 	title = #{title}, content = #{content}
	 	where bno = #{bno}
	 </update>
	 
	 <!-- 게시글 삭제 처리 -->
	 <update id="deleteArticle">
	 	update board set show = 'n'
	 	where bno = #{bno}
	 </update>
	 
 </mapper>